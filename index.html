<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>Diesel Pro - Monitor de Taller</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Tema Alto Contraste / Industrial */
        body { background-color: #121212; color: #ffffff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; background-color: #1e1e1e; padding: 20px 50px; border-bottom: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .logo { background-color: #eab308; padding: 10px 20px; font-size: 28px; font-weight: bold; border-radius: 8px; color: #121212; }
        .title { font-size: 36px; font-weight: bold; color: #f8fafc; }
        
        .status-badge { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; }
        .status-badge.connected { background-color: rgba(74, 222, 128, 0.15); color: #4ade80; border: 1px solid #4ade80; }
        .status-badge.disconnected { background-color: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid #ef4444; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; background-color: currentColor; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .clock { font-size: 42px; color: #4ade80; font-family: monospace; font-weight: bold; }

        .grid-container { display: flex; flex-direction: column; gap: 15px; padding: 30px 40px; max-height: calc(100vh - 120px); overflow-y: auto; }
        
        /* Definici√≥n de la grilla de 6 columnas */
        .card { 
            display: grid; grid-template-columns: 0.8fr 1.3fr 1fr 0.9fr 1fr 0.65fr; 
            gap: 15px; align-items: center; background-color: #1e1e1e; 
            border-left: 10px solid #eab308; padding: 20px 25px; border-radius: 8px; 
            font-size: 20px; position: relative; transition: all 0.3s ease; border: 1px solid #333;
        }
        
        /* Modificadores de estado en alto contraste */
        .card.en-proceso { border-left-color: #f97316; }
        .card.cotizado { border-left-color: #a855f7; }
        
        .card.saliendo { border-left-color: #4ade80 !important; background-color: #064e3b !important; animation: parpadeo 1s infinite; }
        @keyframes parpadeo { 0%,100% { box-shadow: 0 0 15px rgba(74,222,128,0.2); } 50% { box-shadow: 0 0 30px rgba(74,222,128,0.6); } }
        
        .countdown-badge { position: absolute; top: -12px; right: 20px; background-color: #4ade80; color: #064e3b; font-size: 14px; font-weight: bold; padding: 4px 14px; border-radius: 12px; border: 2px solid #121212; }
        
        .removing { animation: fadeOut 0.7s forwards; overflow: hidden; pointer-events: none; }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(80px); max-height: 0; padding: 0; margin: 0; border: none; } }

        .fecha-label { font-size: 12px; color: #a1a1aa; font-weight: bold; text-transform: uppercase; }
        .fecha-valor { font-size: 18px; color: #4ade80; font-weight: bold; }
        .empresa { font-size: 24px; font-weight: bold; color: #ffffff; }
        .componente { font-size: 17px; color: #a1a1aa; }
        .solicitante-valor { color: #f8fafc; font-weight: 600; }
        .operario { color: #eab308; font-weight: bold; }
        
        .badge-informe { padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: bold; text-align: center; }
        .badge-informe.listo { background-color: #065f46; color: #34d399; border: 1px solid #047857; }
        .badge-informe.pendiente { background-color: #431407; color: #fb923c; border: 1px solid #9a3412; }
        
        .estado { font-size: 18px; font-weight: bold; padding: 12px 18px; border-radius: 8px; background-color: #27272a; color: #f4f4f5; text-align: center; white-space: nowrap; border: 1px solid #3f3f46; }
        .empty-state { text-align: center; font-size: 36px; padding: 100px; color: #52525b; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center; gap:20px;">
        <div class="logo">DP</div>
        <div class="title">MONITOR DE TALLER</div>
    </div>
    <div style="display:flex; align-items:center; gap:20px;">
        <div class="status-badge disconnected" id="status-badge">
            <div class="status-dot"></div>
            <span id="status-text">Iniciando...</span>
        </div>
        <div class="clock" id="reloj">00:00:00</div>
    </div>
</div>

<div class="grid-container" id="contenedor-tareas">
    <div class="empty-state">‚è≥ Cargando tareas del taller...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = 'https://uobfergikgoxqqnmdbgw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYmZlcmdpa2dveHFxbm1kYmd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTU5OTAsImV4cCI6MjA4NzQzMTk5MH0.FhJr4aDyMOyPv6ea44aYQSZhxeAK3988M-Zb4oVDgww';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const timersActivos = {};
const ESTADOS_PERMITIDOS = ['PENDIENTE', 'EN_PROCESO', 'COTIZADO'];

function actualizarReloj() {
    document.getElementById('reloj').textContent = new Date().toLocaleTimeString('es-PE', { hour12: false });
}
setInterval(actualizarReloj, 1000);

function setStatus(connected, text) {
    const badge = document.getElementById('status-badge');
    badge.className = `status-badge ${connected ? 'connected' : 'disconnected'}`;
    document.getElementById('status-text').textContent = text;
}

function cumpleCondicionSalida(t) {
    const tieneCot = (t.nro_cotizacion_vinculada && t.nro_cotizacion_vinculada.trim() !== '');
    const informeOk = (!t.requiere_informe || t.informe_listo);
    return tieneCot && informeOk;
}

function formatFecha(raw) {
    if (!raw) return '--:--';
    const f = new Date(raw);
    return f.toLocaleDateString('es-PE', {day:'2-digit', month:'2-digit'}) + ' ' + f.toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'});
}

function crearCard(t) {
    const card = document.createElement('div');
    card.className = `card ${t.estado === 'COTIZADO' ? 'cotizado' : (t.estado === 'EN_PROCESO' ? 'en-proceso' : '')}`;
    card.dataset.id = t.id_tarea;
    
    const txtEstado = t.estado === 'COTIZADO' 
        ? `üìÑ ${t.nro_cotizacion_vinculada || 'COTIZADO'}` 
        : (t.estado === 'EN_PROCESO' ? '‚öôÔ∏è EN PROCESO' : 'üìã PENDIENTE');

    // Notaci√≥n espec√≠fica para renderizado condicional de columnas
    let bloqueInformeHtml = '';
    let parametroExpansion = '';

    if (t.requiere_informe) {
        bloqueInformeHtml = `
            <div style="text-align:center">
                <div class="badge-informe ${t.informe_listo ? 'listo' : 'pendiente'}">
                    ${t.informe_listo ? '‚úÖ INFORME' : '‚è≥ INFORME'}
                </div>
            </div>`;
    } else {
        // Al asignar span 2, el elemento ocupa el vector [C5, C6] de la grilla
        parametroExpansion = 'grid-column: span 2; width: 100%;';
    }

    card.innerHTML = `
        <div class="col-fecha"><span class="fecha-label">üìÖ Ingreso</span><br><span class="fecha-valor">${formatFecha(t.fecha_ingreso)}</span></div>
        <div class="col-empresa"><div class="empresa">${t.empresa || 'S/N'}</div><div class="componente">${t.componente || '---'}</div></div>
        <div><span class="fecha-label">üë§ Solicitante</span><br><span class="solicitante-valor">${t.solicitante || '---'}</span></div>
        <div class="operario">üîß ${t.operario_asignado || 'Sin asignar'}</div>
        ${bloqueInformeHtml}
        <div class="estado" style="${parametroExpansion}">${txtEstado}</div>
    `;
    return card;
}

function quitarCard(idTarea) {
    const card = document.querySelector(`.card[data-id="${idTarea}"]`);
    if (card && !card.classList.contains('removing')) {
        if (timersActivos[idTarea]) { clearInterval(timersActivos[idTarea]); delete timersActivos[idTarea]; }
        card.classList.add('removing');
        setTimeout(() => { 
            card.remove(); 
            validarContenedorVacio();
        }, 700);
    }
}

function validarContenedorVacio() {
    const cont = document.getElementById('contenedor-tareas');
    if (cont.querySelectorAll('.card:not(.removing)').length === 0) {
        cont.innerHTML = '<div class="empty-state">‚úÖ SIN TAREAS ACTIVAS EN TALLER</div>';
    }
}

function iniciarCountdown(idTarea) {
    if (timersActivos[idTarea]) return;
    const card = document.querySelector(`.card[data-id="${idTarea}"]`);
    if (!card) return;

    card.classList.add('saliendo');
    let s = 10;
    const b = document.createElement('div');
    b.className = 'countdown-badge';
    b.textContent = `‚úÖ Listo ¬∑ Saliendo en ${s}s`;
    card.appendChild(b);

    timersActivos[idTarea] = setInterval(() => {
        s--;
        b.textContent = `‚úÖ Listo ¬∑ Saliendo en ${s}s`;
        if (s <= 0) { quitarCard(idTarea); }
    }, 1000);
}

async function cargarDatos() {
    const { data, error } = await db.from('tareas_taller')
        .select('*')
        .in('estado', ESTADOS_PERMITIDOS)
        .order('fecha_ingreso', {ascending: true});

    if (error) { setStatus(false, 'Error de conexi√≥n'); return; }

    const cont = document.getElementById('contenedor-tareas');
    const tareasParaMostrar = data.filter(t => !cumpleCondicionSalida(t));

    const cardsEnPantalla = document.querySelectorAll('.card');
    cardsEnPantalla.forEach(card => {
        const id = parseInt(card.dataset.id);
        if (!tareasParaMostrar.find(t => t.id_tarea === id)) {
            quitarCard(id);
        }
    });

    if (tareasParaMostrar.length === 0) {
        validarContenedorVacio();
    } else {
        const empty = cont.querySelector('.empty-state');
        if (empty) empty.remove();

        tareasParaMostrar.forEach(t => {
            const existe = document.querySelector(`.card[data-id="${t.id_tarea}"]`);
            if (!existe) {
                cont.appendChild(crearCard(t));
            } else if (!existe.classList.contains('removing') && !existe.classList.contains('saliendo')) {
                const clon = crearCard(t);
                existe.innerHTML = clon.innerHTML;
                existe.className = clon.className;
            }
        });
    }
    setStatus(true, 'üü¢ Monitor Activo');
}

function iniciarEscuchaRealtime() {
    db.channel('cambios-taller')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'tareas_taller' }, payload => {
            console.log('Cambio detectado:', payload.eventType, payload.new);
            
            if (payload.eventType === 'DELETE' || (payload.new && !ESTADOS_PERMITIDOS.includes(payload.new.estado))) {
                quitarCard(payload.new ? payload.new.id_tarea : payload.old.id_tarea);
                return;
            }

            if (cumpleCondicionSalida(payload.new)) {
                iniciarCountdown(payload.new.id_tarea);
            } else {
                cargarDatos();
            }
        })
        .subscribe();
}

cargarDatos().then(iniciarEscuchaRealtime);
setInterval(cargarDatos, 120000);

</script>
</body>
</html>
