<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diesel Pro - Tablero de Taller</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            margin: 0;
            background-color: #0f172a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1e293b;
            padding: 20px 50px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .logo-container { display: flex; align-items: center; gap: 20px; }
        .logo { background-color: #f59e0b; padding: 10px 20px; font-size: 28px; font-weight: bold; border-radius: 8px; color: #0f172a; }
        .title { font-size: 36px; font-weight: bold; color: #f8fafc; }

        .header-right { display: flex; align-items: center; gap: 20px; }

        .status-badge {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 20px;
            font-size: 14px; font-weight: bold;
            transition: all 0.3s ease;
        }
        .status-badge.connected  { background-color: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.3); }
        .status-badge.disconnected { background-color: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-badge.connected .status-dot    { background-color: #10b981; }
        .status-badge.disconnected .status-dot { background-color: #ef4444; animation: none; }

        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        .clock { font-size: 42px; color: #38bdf8; font-family: 'Courier New', monospace; font-weight: bold; }

        .grid-container {
            display: flex; flex-direction: column; gap: 15px;
            padding: 30px 40px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        .grid-container::-webkit-scrollbar       { width: 10px; }
        .grid-container::-webkit-scrollbar-track { background: #1e293b; }
        .grid-container::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 5px; }

        .card {
            display: grid;
            grid-template-columns: 0.8fr 1.2fr 1fr 0.8fr 0.9fr 0.6fr;
            gap: 15px; align-items: center;
            background-color: #1e293b;
            border-left: 12px solid #f59e0b;
            padding: 20px 25px; border-radius: 10px;
            font-size: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        .card.en-proceso { border-left-color: #3b82f6; background-color: #172554; }
        .card.cotizado   { border-left-color: #8b5cf6; background-color: #2e1065; }

        .col-fecha { display: flex; flex-direction: column; gap: 5px; }
        .fecha-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; font-weight: bold; }
        .fecha-valor { font-size: 18px; color: #38bdf8; font-family: 'Courier New', monospace; font-weight: bold; }

        .col-empresa { display: flex; flex-direction: column; gap: 3px; }
        .empresa    { font-size: 26px; font-weight: bold; color: #f8fafc; }
        .componente { font-size: 18px; color: #94a3b8; }

        .col-solicitante { display: flex; flex-direction: column; gap: 3px; }
        .solicitante-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; }
        .solicitante-valor { font-size: 20px; color: #fbbf24; font-weight: 600; }

        .operario { color: #fbbf24; font-weight: bold; font-size: 20px; }

        /* â”€â”€ Columna informe â€” ahora muestra el estado del informe â”€â”€ */
        .col-informe { display: flex; align-items: center; justify-content: center; }
        .badge-informe { padding: 8px 14px; border-radius: 20px; font-size: 15px; font-weight: bold; text-align: center; }
        .badge-informe.no-requiere  { background-color: #334155; color: #94a3b8; }
        .badge-informe.pendiente    { background-color: #92400e; color: #fde68a; }
        .badge-informe.listo        { background-color: #10b981; color: #ffffff; }

        .estado { font-size: 18px; font-weight: bold; padding: 10px 20px; border-radius: 20px; background-color: #fef3c7; color: #b45309; text-align: center; white-space: nowrap; }
        .card.en-proceso .estado { background-color: #dbeafe; color: #1d4ed8; }
        .card.cotizado   .estado { background-color: #e9d5ff; color: #6b21a8; }

        .empty-state { text-align: center; font-size: 40px; padding: 100px; color: #475569; }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); max-height: 100px; }
            to   { opacity: 0; transform: translateX(40px); max-height: 0; padding: 0; margin: 0; }
        }
        .card.removing { animation: fadeOut 0.6s ease-out forwards; overflow: hidden; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        .card { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-container">
        <div class="logo">DP</div>
        <div class="title">TAREAS EN TALLER</div>
    </div>
    <div class="header-right">
        <div class="status-badge disconnected" id="status-badge">
            <div class="status-dot"></div>
            <span id="status-text">Conectando...</span>
        </div>
        <div class="clock" id="reloj"></div>
    </div>
</div>

<div class="grid-container" id="contenedor-tareas">
    <div class="empty-state">â³ Conectando con Supabase...</div>
</div>

<!-- âœ… CDN con ruta UMD explÃ­cita -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL     = 'https://uobfergikgoxqqnmdbgw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYmZlcmdpa2dveHFxbm1kYmd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTU5OTAsImV4cCI6MjA4NzQzMTk5MH0.FhJr4aDyMOyPv6ea44aYQSZhxeAK3988M-Zb4oVDgww';

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RELOJ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function actualizarReloj() {
    const d = new Date();
    document.getElementById('reloj').textContent =
        `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
setInterval(actualizarReloj, 1000);
actualizarReloj();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(connected, text) {
    const badge = document.getElementById('status-badge');
    badge.className = `status-badge ${connected ? 'connected' : 'disconnected'}`;
    document.getElementById('status-text').textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœ… REGLA DE VISIBILIDAD
//
// Con informe  â†’ ocultar cuando: informe_estado === 'LISTO' && nro_cotizacion_vinculada no vacÃ­o
// Sin informe  â†’ ocultar cuando: nro_cotizacion_vinculada no vacÃ­o
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function debeOcultarse(t) {
    const tieneCotizacion = t.nro_cotizacion_vinculada && t.nro_cotizacion_vinculada.trim() !== '';

    if (t.requiere_informe) {
        // Debe cumplirse AMBAS condiciones
        return t.informe_estado === 'LISTO' && tieneCotizacion;
    } else {
        // Solo necesita cotizaciÃ³n
        return tieneCotizacion;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BADGE DE INFORME â€” refleja el estado real
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function badgeInforme(t) {
    if (!t.requiere_informe) {
        return `<div class="badge-informe no-requiere">âšª SIN INFORME</div>`;
    }
    if (t.informe_estado === 'LISTO') {
        return `<div class="badge-informe listo">âœ… INFORME LISTO</div>`;
    }
    return `<div class="badge-informe pendiente">â³ INFORME PENDIENTE</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERIZAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderizar(lista) {
    const contenedor = document.getElementById('contenedor-tareas');
    contenedor.innerHTML = '';

    // Filtrar usando la regla de visibilidad
    const visibles = lista.filter(t => !debeOcultarse(t));

    if (visibles.length === 0) {
        contenedor.innerHTML = '<div class="empty-state">âœ… NO HAY TAREAS ACTIVAS EN TALLER</div>';
        return;
    }

    visibles.forEach(t => {
        const enProceso = t.estado === 'EN_PROCESO';
        const cotizado  = t.estado === 'COTIZADO';

        let fechaFormateada = 'Sin fecha';
        if (t.fecha_ingreso) {
            try {
                const f = new Date(t.fecha_ingreso);
                fechaFormateada = `${String(f.getDate()).padStart(2,'0')}/${String(f.getMonth()+1).padStart(2,'0')}/${f.getFullYear()} ${String(f.getHours()).padStart(2,'0')}:${String(f.getMinutes()).padStart(2,'0')}`;
            } catch { fechaFormateada = t.fecha_ingreso; }
        }

        const div = document.createElement('div');
        div.className = `card ${cotizado ? 'cotizado' : (enProceso ? 'en-proceso' : '')}`;
        div.dataset.id = t.id_tarea;

        div.innerHTML = `
            <div class="col-fecha">
                <span class="fecha-label">ğŸ“… Ingreso</span>
                <span class="fecha-valor">${fechaFormateada}</span>
            </div>
            <div class="col-empresa">
                <div class="empresa">${t.empresa || 'Sin nombre'}</div>
                <div class="componente">${t.componente || 'Sin especificar'}</div>
            </div>
            <div class="col-solicitante">
                <span class="solicitante-label">ğŸ‘¤ Solicitante</span>
                <span class="solicitante-valor">${t.solicitante || 'No especificado'}</span>
            </div>
            <div class="operario">ğŸ”§ ${t.operario_asignado || 'Sin asignar'}</div>
            <div class="col-informe">${badgeInforme(t)}</div>
            <div class="estado">
                ${cotizado ? 'ğŸ“„ COTIZADO' : (enProceso ? 'âš™ï¸ EN PROCESO' : 'ğŸ“‹ PENDIENTE')}
            </div>
        `;

        contenedor.appendChild(div);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGA INICIAL â€” trae todas las tareas no terminadas
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function cargarInicial() {
    try {
        const { data, error } = await db
            .from('tareas_taller')
            .select('*')
            .in('estado', ['PENDIENTE', 'EN_PROCESO', 'COTIZADO'])
            .order('fecha_ingreso', { ascending: true });

        if (error) throw error;

        console.log(`âœ… ${data.length} tareas cargadas (antes de filtro de visibilidad)`);
        renderizar(data);
        return true;
    } catch (e) {
        console.error('âŒ Error carga inicial:', e);
        document.getElementById('contenedor-tareas').innerHTML =
            '<div class="empty-state">âš ï¸ ERROR DE CONEXIÃ“N CON SUPABASE</div>';
        return false;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REALTIME â€” WebSocket con lÃ³gica de desvanecimiento instantÃ¡neo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarRealtime() {
    const channel = db
        .channel('tareas-taller-tv')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'tareas_taller' },
            (payload) => {
                console.log('ğŸ“¡ Cambio detectado:', payload.eventType, payload.new || payload.old);

                if (payload.eventType === 'DELETE') {
                    // Tarea eliminada fÃ­sicamente â†’ animar y quitar
                    animarYQuitar(payload.old.id_tarea);
                    return;
                }

                const tarea = payload.new;

                if (payload.eventType === 'UPDATE' && debeOcultarse(tarea)) {
                    // âœ… La tarea cumple las condiciones para desaparecer â†’ animar
                    console.log(`âœ… Tarea #${tarea.id_tarea} cumple condiciÃ³n de ocultamiento`);
                    animarYQuitar(tarea.id_tarea);
                } else {
                    // INSERT o UPDATE que no oculta â†’ recargar para mantener consistencia
                    cargarInicial();
                }
            }
        )
        .subscribe((status) => {
            console.log('ğŸ“¡ Realtime status:', status);
            if (status === 'SUBSCRIBED') {
                setStatus(true, 'ğŸŸ¢ Realtime activo');
            } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                setStatus(false, 'ğŸ”´ Reconectando...');
                setTimeout(() => { channel.unsubscribe(); iniciarRealtime(); }, 5000);
            }
        });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANIMAR Y QUITAR â€” desvanece la tarjeta antes de eliminarla del DOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function animarYQuitar(idTarea) {
    const card = document.querySelector(`.card[data-id="${idTarea}"]`);
    if (!card) {
        // No estaba visible, recargar por si acaso
        cargarInicial();
        return;
    }

    card.classList.add('removing');
    card.addEventListener('animationend', () => {
        card.remove();
        // Si no quedan tarjetas, mostrar estado vacÃ­o
        const contenedor = document.getElementById('contenedor-tareas');
        if (contenedor.querySelectorAll('.card').length === 0) {
            contenedor.innerHTML = '<div class="empty-state">âœ… NO HAY TAREAS ACTIVAS EN TALLER</div>';
        }
    }, { once: true });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async () => {
    const ok = await cargarInicial();
    if (ok) {
        iniciarRealtime();
    } else {
        setStatus(false, 'ğŸ”´ Sin conexiÃ³n');
        setInterval(async () => {
            const retry = await cargarInicial();
            if (retry) iniciarRealtime();
        }, 10000);
    }
})();
</script>
</body>
</html>
