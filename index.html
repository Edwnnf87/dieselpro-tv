<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diesel Pro - Tablero de Taller</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            margin: 0;
            background-color: #0f172a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1e293b;
            padding: 20px 50px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .logo-container { display: flex; align-items: center; gap: 20px; }
        .logo { background-color: #f59e0b; padding: 10px 20px; font-size: 28px; font-weight: bold; border-radius: 8px; color: #0f172a; }
        .title { font-size: 36px; font-weight: bold; color: #f8fafc; }
        .header-right { display: flex; align-items: center; gap: 20px; }

        .status-badge {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 20px;
            font-size: 14px; font-weight: bold; transition: all 0.3s ease;
        }
        .status-badge.connected    { background-color: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.3); }
        .status-badge.disconnected { background-color: rgba(239,68,68,0.2);  color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-badge.connected .status-dot    { background-color: #10b981; }
        .status-badge.disconnected .status-dot { background-color: #ef4444; animation: none; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        .clock { font-size: 42px; color: #38bdf8; font-family: 'Courier New', monospace; font-weight: bold; }

        .grid-container {
            display: flex; flex-direction: column; gap: 15px;
            padding: 30px 40px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        .grid-container::-webkit-scrollbar       { width: 10px; }
        .grid-container::-webkit-scrollbar-track { background: #1e293b; }
        .grid-container::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 5px; }

        /* â”€â”€ TARJETA BASE â”€â”€ */
        .card {
            display: grid;
            grid-template-columns: 0.8fr 1.2fr 1fr 0.8fr 1fr 0.7fr;
            gap: 15px; align-items: center;
            background-color: #1e293b;
            border-left: 12px solid #f59e0b;
            padding: 20px 25px; border-radius: 10px;
            font-size: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }

        .card.en-proceso { border-left-color: #3b82f6; background-color: #172554; }
        .card.cotizado   { border-left-color: #8b5cf6; background-color: #2e1065; }

        /* â”€â”€ Tarjeta en salida: borde verde parpadeante + countdown â”€â”€ */
        .card.saliendo {
            border-left-color: #10b981 !important;
            background-color: #052e16 !important;
            box-shadow: 0 0 20px rgba(16,185,129,0.4) !important;
            animation: parpadeo 1s ease-in-out infinite;
        }
        @keyframes parpadeo {
            0%,100% { box-shadow: 0 0 20px rgba(16,185,129,0.4); }
            50%      { box-shadow: 0 0 40px rgba(16,185,129,0.9); }
        }

        /* Countdown overlay */
        .countdown-badge {
            position: absolute;
            top: 10px; right: 15px;
            background-color: #10b981;
            color: white;
            font-size: 13px;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 12px;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); max-height: 120px; }
            to   { opacity: 0; transform: translateX(60px); max-height: 0; padding: 0; margin: 0; }
        }
        .card.removing { animation: fadeOut 0.7s ease-out forwards; overflow: hidden; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        .card-new { animation: slideIn 0.4s ease-out; }

        /* â”€â”€ Columnas â”€â”€ */
        .col-fecha { display: flex; flex-direction: column; gap: 5px; }
        .fecha-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; font-weight: bold; }
        .fecha-valor { font-size: 18px; color: #38bdf8; font-family: 'Courier New', monospace; font-weight: bold; }

        .col-empresa { display: flex; flex-direction: column; gap: 3px; }
        .empresa    { font-size: 24px; font-weight: bold; color: #f8fafc; }
        .componente { font-size: 17px; color: #94a3b8; }

        .col-solicitante { display: flex; flex-direction: column; gap: 3px; }
        .solicitante-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; }
        .solicitante-valor { font-size: 19px; color: #fbbf24; font-weight: 600; }

        .operario { color: #fbbf24; font-weight: bold; font-size: 19px; }

        /* â”€â”€ Badge de informe â”€â”€ */
        .col-informe { display: flex; align-items: center; justify-content: center; }
        .badge-informe {
            padding: 9px 14px; border-radius: 20px;
            font-size: 15px; font-weight: bold; text-align: center;
            transition: all 0.5s ease;
        }
        /* No requiere informe */
        .badge-informe.no-requiere { background-color: #1e293b; color: #475569; border: 1px solid #334155; }
        /* Requiere informe â€” pendiente */
        .badge-informe.pendiente   { background-color: #431407; color: #fed7aa; border: 1px solid #92400e; }
        /* âœ… Informe listo â€” highlight llamativo */
        .badge-informe.listo {
            background-color: #10b981;
            color: #ffffff;
            border: none;
            box-shadow: 0 0 14px rgba(16,185,129,0.7);
            animation: glowInforme 2s ease-in-out infinite;
        }
        @keyframes glowInforme {
            0%,100% { box-shadow: 0 0 10px rgba(16,185,129,0.5); }
            50%      { box-shadow: 0 0 22px rgba(16,185,129,1.0); }
        }

        /* â”€â”€ Estado â”€â”€ */
        .estado { font-size: 17px; font-weight: bold; padding: 10px 18px; border-radius: 20px; background-color: #fef3c7; color: #b45309; text-align: center; white-space: nowrap; }
        .card.en-proceso .estado { background-color: #dbeafe; color: #1d4ed8; }
        .card.cotizado   .estado { background-color: #e9d5ff; color: #6b21a8; }
        .card.saliendo   .estado { background-color: #d1fae5; color: #065f46; }

        .empty-state { text-align: center; font-size: 40px; padding: 100px; color: #475569; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-container">
        <div class="logo">DP</div>
        <div class="title">MONITOR DE TALLER</div>
    </div>
    <div class="header-right">
        <div class="status-badge disconnected" id="status-badge">
            <div class="status-dot"></div>
            <span id="status-text">Conectando...</span>
        </div>
        <div class="clock" id="reloj"></div>
    </div>
</div>

<div class="grid-container" id="contenedor-tareas">
    <div class="empty-state">â³ Conectando con Supabase...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL      = 'https://uobfergikgoxqqnmdbgw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYmZlcmdpa2dveHFxbm1kYmd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTU5OTAsImV4cCI6MjA4NzQzMTk5MH0.FhJr4aDyMOyPv6ea44aYQSZhxeAK3988M-Zb4oVDgww';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Mapa de timers activos: id_tarea â†’ timer id
const timersÑĞ°Ğ»Ğ¸Ğ´Ğ° = {};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RELOJ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function actualizarReloj() {
    const d = new Date();
    document.getElementById('reloj').textContent =
        `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
setInterval(actualizarReloj, 1000);
actualizarReloj();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATUS BADGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(connected, text) {
    const badge = document.getElementById('status-badge');
    badge.className = `status-badge ${connected ? 'connected' : 'disconnected'}`;
    document.getElementById('status-text').textContent = text;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âœ… CONDICIÃ“N DE SALIDA
// (NOT requiere_informe OR informe_listo) AND nro_cotizacion_vinculada NOT NULL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cumpleCondicionSalida(t) {
    const tieneCotizacion = t.nro_cotizacion_vinculada && t.nro_cotizacion_vinculada.trim() !== '';
    const informeOK       = !t.requiere_informe || t.informe_estado === 'LISTO';
    return informeOK && tieneCotizacion;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BADGE DE INFORME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function badgeInforme(t) {
    if (!t.requiere_informe)
        return `<div class="badge-informe no-requiere">â€” Sin informe</div>`;
    if (t.informe_estado === 'LISTO')
        return `<div class="badge-informe listo">âœ… INFORME LISTO</div>`;
    return `<div class="badge-informe pendiente">â³ Informe pendiente</div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FORMATEAR FECHA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatFecha(raw) {
    if (!raw) return 'Sin fecha';
    try {
        const f = new Date(raw);
        return `${String(f.getDate()).padStart(2,'0')}/${String(f.getMonth()+1).padStart(2,'0')}/${f.getFullYear()} `
             + `${String(f.getHours()).padStart(2,'0')}:${String(f.getMinutes()).padStart(2,'0')}`;
    } catch { return raw; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CREAR TARJETA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function crearCard(t) {
    const enProceso = t.estado === 'EN_PROCESO';
    const cotizado  = t.estado === 'COTIZADO';

    const div = document.createElement('div');
    div.className = `card card-new ${cotizado ? 'cotizado' : (enProceso ? 'en-proceso' : '')}`;
    div.dataset.id = t.id_tarea;

    div.innerHTML = `
        <div class="col-fecha">
            <span class="fecha-label">ğŸ“… Ingreso</span>
            <span class="fecha-valor">${formatFecha(t.fecha_ingreso)}</span>
        </div>
        <div class="col-empresa">
            <div class="empresa">${t.empresa || 'Sin nombre'}</div>
            <div class="componente">${t.componente || 'Sin especificar'}</div>
        </div>
        <div class="col-solicitante">
            <span class="solicitante-label">ğŸ‘¤ Solicitante</span>
            <span class="solicitante-valor">${t.solicitante || 'No especificado'}</span>
        </div>
        <div class="operario">ğŸ”§ ${t.operario_asignado || 'Sin asignar'}</div>
        <div class="col-informe">${badgeInforme(t)}</div>
        <div class="estado">
            ${cotizado ? 'ğŸ“„ COTIZADO' : (enProceso ? 'âš™ï¸ EN PROCESO' : 'ğŸ“‹ PENDIENTE')}
        </div>
    `;

    return div;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACTUALIZAR TARJETA EXISTENTE (sin recrearla para no perder animaciones)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function actualizarCard(card, t) {
    const enProceso = t.estado === 'EN_PROCESO';
    const cotizado  = t.estado === 'COTIZADO';

    // Actualizar clases de estado
    card.className = card.className
        .replace(/\b(en-proceso|cotizado)\b/g, '').trim();
    if (cotizado)  card.classList.add('cotizado');
    if (enProceso) card.classList.add('en-proceso');

    // Actualizar badge de informe
    const colInforme = card.querySelector('.col-informe');
    if (colInforme) colInforme.innerHTML = badgeInforme(t);

    // Actualizar estado
    const estadoDiv = card.querySelector('.estado');
    if (estadoDiv)
        estadoDiv.textContent = cotizado ? 'ğŸ“„ COTIZADO' : (enProceso ? 'âš™ï¸ EN PROCESO' : 'ğŸ“‹ PENDIENTE');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INICIAR COUNTDOWN DE SALIDA (10 segundos)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function iniciarCountdown(idTarea) {
    // Evitar timers duplicados
    if (timersĞ°Ğ»Ğ¸Ğ´Ğ°[idTarea]) return;

    const card = document.querySelector(`.card[data-id="${idTarea}"]`);
    if (!card) return;

    card.classList.add('saliendo');

    // Agregar badge de countdown
    let segundos = 10;
    const badge = document.createElement('div');
    badge.className = 'countdown-badge';
    badge.textContent = `âœ… Completado Â· saliendo en ${segundos}s`;
    card.appendChild(badge);

    const interval = setInterval(() => {
        segundos--;
        badge.textContent = `âœ… Completado Â· saliendo en ${segundos}s`;
        if (segundos <= 0) {
            clearInterval(interval);
            delete timersĞ°Ğ»Ğ¸Ğ´Ğ°[idTarea];
            quitarCard(idTarea);
        }
    }, 1000);

    timersĞ°Ğ»Ğ¸Ğ´Ğ°[idTarea] = interval;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// QUITAR TARJETA CON ANIMACIÃ“N
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function quitarCard(idTarea) {
    const card = document.querySelector(`.card[data-id="${idTarea}"]`);
    if (!card) return;

    card.classList.remove('saliendo');
    card.classList.add('removing');
    card.addEventListener('animationend', () => {
        card.remove();
        const contenedor = document.getElementById('contenedor-tareas');
        if (contenedor.querySelectorAll('.card').length === 0)
            contenedor.innerHTML = '<div class="empty-state">âœ… NO HAY TAREAS ACTIVAS EN TALLER</div>';
    }, { once: true });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CARGA INICIAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function cargarInicial() {
    try {
        const { data, error } = await db
            .from('tareas_taller')
            .select('*')
            .in('estado', ['PENDIENTE', 'EN_PROCESO', 'COTIZADO'])
            .order('fecha_ingreso', { ascending: true });

        if (error) throw error;

        const contenedor = document.getElementById('contenedor-tareas');
        contenedor.innerHTML = '';

        // Filtrar: no mostrar las que ya cumplen condiciÃ³n de salida
        const visibles = data.filter(t => !cumpleCondicionSalida(t));

        if (visibles.length === 0) {
            contenedor.innerHTML = '<div class="empty-state">âœ… NO HAY TAREAS ACTIVAS EN TALLER</div>';
        } else {
            visibles.forEach(t => contenedor.appendChild(crearCard(t)));
        }

        console.log(`âœ… ${visibles.length}/${data.length} tareas visibles`);
        return true;
    } catch (e) {
        console.error('âŒ Error carga inicial:', e);
        document.getElementById('contenedor-tareas').innerHTML =
            '<div class="empty-state">âš ï¸ ERROR DE CONEXIÃ“N</div>';
        return false;
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REALTIME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function iniciarRealtime() {
    const channel = db
        .channel('monitor-taller-v2')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'tareas_taller' },
            (payload) => {
                console.log('ğŸ“¡', payload.eventType, payload.new || payload.old);

                // â”€â”€ DELETE fÃ­sico â”€â”€
                if (payload.eventType === 'DELETE') {
                    if (timersĞ°Ğ»Ğ¸Ğ´Ğ°[payload.old.id_tarea]) {
                        clearInterval(timersĞ°Ğ»Ğ¸Ğ´Ğ°[payload.old.id_tarea]);
                        delete timersĞ°Ğ»Ğ¸Ğ´Ğ°[payload.old.id_tarea];
                    }
                    quitarCard(payload.old.id_tarea);
                    return;
                }

                const tarea = payload.new;
                const idTarea = tarea.id_tarea;
                const cardExistente = document.querySelector(`.card[data-id="${idTarea}"]`);

                if (payload.eventType === 'INSERT') {
                    // Nueva tarea â†’ agregar si no cumple condiciÃ³n de salida
                    if (!cumpleCondicionSalida(tarea)) {
                        const contenedor = document.getElementById('contenedor-tareas');
                        const emptyState = contenedor.querySelector('.empty-state');
                        if (emptyState) emptyState.remove();
                        contenedor.appendChild(crearCard(tarea));
                    }
                    return;
                }

                // â”€â”€ UPDATE â”€â”€
                if (cumpleCondicionSalida(tarea)) {
                    // âœ… CondiciÃ³n de salida cumplida â†’ countdown de 10s
                    if (cardExistente && !cardExistente.classList.contains('saliendo')) {
                        actualizarCard(cardExistente, tarea); // reflejar estado final primero
                        iniciarCountdown(idTarea);
                    } else if (!cardExistente) {
                        // Ya no estaba visible, ignorar
                    }
                } else {
                    // ActualizaciÃ³n parcial (ej: informe marcado LISTO pero sin cotizaciÃ³n aÃºn)
                    if (cardExistente) {
                        actualizarCard(cardExistente, tarea);
                        // Si habÃ­a un timer de salida activo pero ya no cumple â†’ cancelar
                        if (timersĞ°Ğ»Ğ¸Ğ´Ğ°[idTarea]) {
                            clearInterval(timersĞ°Ğ»Ğ¸Ğ´Ğ°[idTarea]);
                            delete timersĞ°Ğ»Ğ¸Ğ´Ğ°[idTarea];
                            cardExistente.classList.remove('saliendo');
                            const badge = cardExistente.querySelector('.countdown-badge');
                            if (badge) badge.remove();
                        }
                    } else {
                        // Tarea que no estaba visible y ahora debe mostrarse
                        const contenedor = document.getElementById('contenedor-tareas');
                        const emptyState = contenedor.querySelector('.empty-state');
                        if (emptyState) emptyState.remove();
                        contenedor.appendChild(crearCard(tarea));
                    }
                }
            }
        )
        .subscribe((status) => {
            console.log('ğŸ“¡ Realtime status:', status);
            if (status === 'SUBSCRIBED') {
                setStatus(true, 'ğŸŸ¢ Realtime activo');
            } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                setStatus(false, 'ğŸ”´ Reconectando...');
                setTimeout(() => { channel.unsubscribe(); iniciarRealtime(); }, 5000);
            }
        });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INICIO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
    const ok = await cargarInicial();
    if (ok) {
        iniciarRealtime();
    } else {
        setStatus(false, 'ğŸ”´ Sin conexiÃ³n');
        setInterval(async () => {
            const retry = await cargarInicial();
            if (retry) iniciarRealtime();
        }, 10000);
    }
})();
</script>
</body>
</html>
