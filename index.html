<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diesel Pro - Tablero de Taller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            background-color: #0f172a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1e293b;
            padding: 20px 50px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            background-color: #f59e0b;
            padding: 10px 20px;
            font-size: 28px;
            font-weight: bold;
            border-radius: 8px;
            color: #0f172a;
        }
        
        .title {
            font-size: 36px;
            font-weight: bold;
            color: #f8fafc;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status-badge.connected {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-badge.disconnected {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-badge.connected .status-dot {
            background-color: #10b981;
        }

        .status-badge.disconnected .status-dot {
            background-color: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .clock {
            font-size: 42px;
            color: #38bdf8;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .grid-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 30px 40px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        
        .grid-container::-webkit-scrollbar { width: 10px; }
        .grid-container::-webkit-scrollbar-track { background: #1e293b; }
        .grid-container::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 5px; }
        
        .card {
            display: grid;
            grid-template-columns: 0.8fr 1.2fr 1fr 0.8fr 0.7fr 0.6fr;
            gap: 15px;
            align-items: center;
            background-color: #1e293b;
            border-left: 12px solid #f59e0b;
            padding: 20px 25px;
            border-radius: 10px;
            font-size: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .card.en-proceso { border-left-color: #3b82f6; background-color: #172554; }
        .card.cotizado   { border-left-color: #8b5cf6; background-color: #2e1065; }
        
        .col-fecha { display: flex; flex-direction: column; gap: 5px; }
        .fecha-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; font-weight: bold; }
        .fecha-valor { font-size: 18px; color: #38bdf8; font-family: 'Courier New', monospace; font-weight: bold; }
        
        .col-empresa { display: flex; flex-direction: column; gap: 3px; }
        .empresa { font-size: 26px; font-weight: bold; color: #f8fafc; }
        .componente { font-size: 18px; color: #94a3b8; }
        
        .col-solicitante { display: flex; flex-direction: column; gap: 3px; }
        .solicitante-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; }
        .solicitante-valor { font-size: 20px; color: #fbbf24; font-weight: 600; }
        
        .operario { color: #fbbf24; font-weight: bold; font-size: 20px; }
        
        .col-informe { display: flex; align-items: center; justify-content: center; }
        .badge-informe { padding: 8px 16px; border-radius: 20px; font-size: 16px; font-weight: bold; text-align: center; }
        .badge-informe.si { background-color: #10b981; color: #ffffff; }
        .badge-informe.no { background-color: #64748b; color: #cbd5e1; }
        
        .estado { font-size: 18px; font-weight: bold; padding: 10px 20px; border-radius: 20px; background-color: #fef3c7; color: #b45309; text-align: center; white-space: nowrap; }
        .card.en-proceso .estado { background-color: #dbeafe; color: #1d4ed8; }
        .card.cotizado .estado   { background-color: #e9d5ff; color: #6b21a8; }
        
        .empty-state { text-align: center; font-size: 40px; padding: 100px; color: #475569; }

        /* Flash de actualizaciÃ³n */
        @keyframes flashUpdate {
            0% { background-color: rgba(56, 189, 248, 0.3); }
            100% { background-color: transparent; }
        }
        .card.updated { animation: flashUpdate 1s ease-out; }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        .card { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-container">
        <div class="logo">DP</div>
        <div class="title">TAREAS EN TALLER</div>
    </div>
    <div class="header-right">
        <div class="status-badge disconnected" id="status-badge">
            <div class="status-dot"></div>
            <span id="status-text">Conectando...</span>
        </div>
        <div class="clock" id="reloj"></div>
    </div>
</div>

<div class="grid-container" id="contenedor-tareas">
    <div class="empty-state">â³ Conectando con Supabase...</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SUPABASE JS SDK (CDN) -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://tahlhiubvhbivqmnoolk.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_NK-dS5WtaCNjFClShv_toQ_nQHNSGNf';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RELOJ EN TIEMPO REAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function actualizarReloj() {
    const ahora = new Date();
    const horas = String(ahora.getHours()).padStart(2, '0');
    const minutos = String(ahora.getMinutes()).padStart(2, '0');
    const segundos = String(ahora.getSeconds()).padStart(2, '0');
    document.getElementById('reloj').textContent = `${horas}:${minutos}:${segundos}`;
}
setInterval(actualizarReloj, 1000);
actualizarReloj();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS BADGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(connected, text) {
    const badge = document.getElementById('status-badge');
    const statusText = document.getElementById('status-text');
    badge.className = `status-badge ${connected ? 'connected' : 'disconnected'}`;
    statusText.textContent = text || (connected ? 'ğŸŸ¢ Realtime activo' : 'ğŸ”´ Desconectado');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERIZAR TARJETAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderizar(lista) {
    const contenedor = document.getElementById('contenedor-tareas');
    contenedor.innerHTML = '';
    
    if (!lista || lista.length === 0) {
        contenedor.innerHTML = '<div class="empty-state">âœ… NO HAY TAREAS PENDIENTES EN TALLER</div>';
        return;
    }
    
    lista.forEach(t => {
        const enProceso = t.estado === "EN_PROCESO";
        const cotizado = t.estado === "COTIZADO";
        const tieneInforme = t.informe_estado && t.informe_estado.trim() !== '';
        
        let fechaFormateada = 'Sin fecha';
        if (t.fecha_ingreso) {
            try {
                const fecha = new Date(t.fecha_ingreso);
                const dia = String(fecha.getDate()).padStart(2, '0');
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const aÃ±o = fecha.getFullYear();
                const hora = String(fecha.getHours()).padStart(2, '0');
                const min = String(fecha.getMinutes()).padStart(2, '0');
                fechaFormateada = `${dia}/${mes}/${aÃ±o} ${hora}:${min}`;
            } catch (e) {
                fechaFormateada = t.fecha_ingreso;
            }
        }
        
        const div = document.createElement("div");
        div.className = `card ${cotizado ? "cotizado" : (enProceso ? "en-proceso" : "")}`;
        div.dataset.id = t.id_tarea;
        
        div.innerHTML = `
            <div class="col-fecha">
                <span class="fecha-label">ğŸ“… Ingreso</span>
                <span class="fecha-valor">${fechaFormateada}</span>
            </div>
            <div class="col-empresa">
                <div class="empresa">${t.empresa || 'Sin nombre'}</div>
                <div class="componente">${t.componente || 'Sin especificar'}</div>
            </div>
            <div class="col-solicitante">
                <span class="solicitante-label">ğŸ‘¤ Solicitante</span>
                <span class="solicitante-valor">${t.solicitante || 'No especificado'}</span>
            </div>
            <div class="operario">
                ğŸ”§ ${t.operario_asignado || 'Sin asignar'}
            </div>
            <div class="col-informe">
                <div class="badge-informe ${tieneInforme ? 'si' : 'no'}">
                    ${tieneInforme ? 'ğŸ“‹ CON INFORME' : 'âšª SIN INFORME'}
                </div>
            </div>
            <div class="estado">
                ${cotizado ? 'ğŸ“„ COTIZADO' : (enProceso ? 'âš™ï¸ EN PROCESO' : 'ğŸ“‹ PENDIENTE')}
            </div>
        `;
        
        contenedor.appendChild(div);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGA INICIAL â€” REST API de Supabase
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function cargarInicial() {
    try {
        console.log('ğŸ”„ Carga inicial desde Supabase...');
        const { data, error } = await supabase
            .from('tareas_taller')
            .select('*')
            .in('estado', ['PENDIENTE', 'EN_PROCESO', 'COTIZADO'])
            .order('fecha_ingreso', { ascending: true });
        
        if (error) throw error;
        
        console.log(`âœ… ${data.length} tareas cargadas`);
        renderizar(data);
        return true;
    } catch (e) {
        console.error("âŒ Error carga inicial:", e);
        document.getElementById('contenedor-tareas').innerHTML = 
            '<div class="empty-state">âš ï¸ ERROR DE CONEXIÃ“N CON SUPABASE</div>';
        return false;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”¥ REALTIME â€” WebSocket (sin polling, sin consumo en reposo)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarRealtime() {
    const channel = supabase
        .channel('tareas-taller-tv')
        .on(
            'postgres_changes',
            {
                event: '*',              // INSERT, UPDATE, DELETE
                schema: 'public',
                table: 'tareas_taller'
            },
            (payload) => {
                console.log('ğŸ“¡ Cambio detectado:', payload.eventType, payload);
                // Recargar toda la lista para mantener consistencia
                cargarInicial();
            }
        )
        .subscribe((status) => {
            console.log('ğŸ“¡ Realtime status:', status);
            if (status === 'SUBSCRIBED') {
                setStatus(true, 'ğŸŸ¢ Realtime activo');
                console.log('âœ… SuscripciÃ³n Realtime activa â€” sin polling');
            } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                setStatus(false, 'ğŸ”´ Error de conexiÃ³n');
                console.error('âŒ Error en Realtime, reintentando...');
                // Reintentar en 5 segundos
                setTimeout(() => {
                    channel.unsubscribe();
                    iniciarRealtime();
                }, 5000);
            }
        });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async () => {
    const ok = await cargarInicial();
    if (ok) {
        iniciarRealtime();
    } else {
        setStatus(false, 'ğŸ”´ Sin conexiÃ³n');
        // Reintentar cada 10s si falla la carga inicial
        setInterval(async () => {
            const retry = await cargarInicial();
            if (retry) {
                iniciarRealtime();
            }
        }, 10000);
    }
})();
</script>
</body>
</html>
