<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,"> 
    <title>Diesel Pro - Monitor de Taller</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0f172a; color: #ffffff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; background-color: #1e293b; padding: 20px 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .logo { background-color: #f59e0b; padding: 10px 20px; font-size: 28px; font-weight: bold; border-radius: 8px; color: #0f172a; }
        .title { font-size: 36px; font-weight: bold; color: #f8fafc; }
        .status-badge { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; }
        .status-badge.connected { background-color: rgba(16,185,129,0.2); color: #10b981; border: 1px solid #10b981; }
        .status-badge.disconnected { background-color: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid #ef4444; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; background-color: currentColor; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .clock { font-size: 42px; color: #38bdf8; font-family: monospace; font-weight: bold; }
        .grid-container { display: flex; flex-direction: column; gap: 15px; padding: 30px 40px; max-height: calc(100vh - 120px); overflow-y: auto; }
        .card { display: grid; grid-template-columns: 0.8fr 1.3fr 1fr 0.9fr 1fr 0.65fr; gap: 15px; align-items: center; background-color: #1e293b; border-left: 12px solid #f59e0b; padding: 20px 25px; border-radius: 10px; font-size: 20px; position: relative; }
        .card.en-proceso { border-left-color: #3b82f6; background-color: #172554; }
        .card.cotizado { border-left-color: #8b5cf6; background-color: #2e1065; }
        .card.saliendo { border-left-color: #10b981 !important; background-color: #052e16 !important; animation: parpadeo 1s infinite; }
        @keyframes parpadeo { 0%,100% { box-shadow: 0 0 20px rgba(16,185,129,0.4); } 50% { box-shadow: 0 0 45px rgba(16,185,129,0.9); } }
        .countdown-badge { position: absolute; top: 10px; right: 15px; background-color: #10b981; color: white; font-size: 13px; font-weight: bold; padding: 4px 14px; border-radius: 12px; }
        .removing { animation: fadeOut 0.7s forwards; overflow: hidden; }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(60px); max-height: 0; padding: 0; margin: 0; } }
        .col-fecha { display: flex; flex-direction: column; }
        .fecha-label { font-size: 12px; color: #94a3b8; font-weight: bold; }
        .fecha-valor { font-size: 18px; color: #38bdf8; font-weight: bold; }
        .empresa { font-size: 24px; font-weight: bold; }
        .componente { font-size: 17px; color: #94a3b8; }
        .solicitante-valor { color: #fbbf24; font-weight: 600; }
        .operario { color: #fbbf24; font-weight: bold; }
        .badge-informe { padding: 9px 16px; border-radius: 20px; font-size: 15px; font-weight: bold; }
        .badge-informe.listo { background-color: #10b981; box-shadow: 0 0 15px rgba(16,185,129,0.5); }
        .badge-informe.pendiente { background-color: #431407; color: #fed7aa; border: 1px solid #92400e; }
        .estado { font-size: 17px; font-weight: bold; padding: 10px 18px; border-radius: 20px; background-color: #fef3c7; color: #b45309; text-align: center; }
        .empty-state { text-align: center; font-size: 40px; padding: 100px; color: #475569; }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center; gap:20px;">
        <div class="logo">DP</div>
        <div class="title">MONITOR DE TALLER</div>
    </div>
    <div style="display:flex; align-items:center; gap:20px;">
        <div class="status-badge disconnected" id="status-badge">
            <div class="status-dot"></div>
            <span id="status-text">Conectando...</span>
        </div>
        <div class="clock" id="reloj">00:00:00</div>
    </div>
</div>

<div class="grid-container" id="contenedor-tareas">
    <div class="empty-state">‚è≥ Cargando monitor...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = 'https://uobfergikgoxqqnmdbgw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYmZlcmdpa2dveHFxbm1kYmd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTU5OTAsImV4cCI6MjA4NzQzMTk5MH0.FhJr4aDyMOyPv6ea44aYQSZhxeAK3988M-Zb4oVDgww';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const timersActivos = {};

function actualizarReloj() {
    const d = new Date();
    document.getElementById('reloj').textContent = d.toLocaleTimeString('es-PE', { hour12: false });
}
setInterval(actualizarReloj, 1000);

function setStatus(connected, text) {
    const badge = document.getElementById('status-badge');
    badge.className = `status-badge ${connected ? 'connected' : 'disconnected'}`;
    document.getElementById('status-text').textContent = text;
}

function cumpleCondicionSalida(t) {
    return (t.nro_cotizacion_vinculada && t.nro_cotizacion_vinculada.trim() !== '') && (!t.requiere_informe || t.informe_listo);
}

function formatFecha(raw) {
    if (!raw) return '--/--';
    const f = new Date(raw);
    return f.toLocaleDateString('es-PE') + ' ' + f.toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'});
}

function crearCard(t) {
    const div = document.createElement('div');
    div.className = `card ${t.estado === 'COTIZADO' ? 'cotizado' : (t.estado === 'EN_PROCESO' ? 'en-proceso' : '')}`;
    div.dataset.id = t.id_tarea;
    
    // Si est√° COTIZADO, mostramos el n√∫mero de cotizaci√≥n
    const txtEstado = t.estado === 'COTIZADO' ? `üìÑ ${t.nro_cotizacion_vinculada || 'COTIZADO'}` : (t.estado === 'EN_PROCESO' ? '‚öôÔ∏è EN PROCESO' : 'üìã PENDIENTE');

    div.innerHTML = `
        <div class="col-fecha"><span class="fecha-label">üìÖ Ingreso</span><span class="fecha-valor">${formatFecha(t.fecha_ingreso)}</span></div>
        <div class="col-empresa"><div class="empresa">${t.empresa || '---'}</div><div class="componente">${t.componente || ''}</div></div>
        <div><span class="fecha-label">üë§ Solicitante</span><br><span class="solicitante-valor">${t.solicitante || '---'}</span></div>
        <div class="operario">üîß ${t.operario_asignado || '---'}</div>
        <div style="text-align:center">${t.requiere_informe ? `<div class="badge-informe ${t.informe_listo?'listo':'pendiente'}">${t.informe_listo?'‚úÖ INFORME':'‚è≥ INFORME'}</div>` : ''}</div>
        <div class="estado">${txtEstado}</div>
    `;
    return div;
}

function quitarCard(idTarea) {
    const card = document.querySelector(`.card[data-id="${idTarea}"]`);
    if (card) {
        card.classList.add('removing');
        setTimeout(() => card.remove(), 700);
    }
}

function iniciarCountdown(idTarea) {
    if (timersActivos[idTarea]) return;
    const card = document.querySelector(`.card[data-id="${idTarea}"]`);
    if (!card) return;
    card.classList.add('saliendo');
    let s = 10;
    const b = document.createElement('div');
    b.className = 'countdown-badge';
    card.appendChild(b);
    timersActivos[idTarea] = setInterval(() => {
        b.textContent = `‚úÖ Listo ¬∑ saliendo en ${s}s`;
        if (s-- <= 0) { clearInterval(timersActivos[idTarea]); delete timersActivos[idTarea]; quitarCard(idTarea); }
    }, 1000);
}

async function cargar() {
    const { data, error } = await db.from('tareas_taller').select('*').in('estado', ['PENDIENTE', 'EN_PROCESO', 'COTIZADO']).order('fecha_ingreso', {ascending: true});
    if (error) return setStatus(false, 'Error BD');
    const cont = document.getElementById('contenedor-tareas');
    cont.innerHTML = '';
    const visibles = data.filter(t => !cumpleCondicionSalida(t));
    if (visibles.length === 0) cont.innerHTML = '<div class="empty-state">‚úÖ SIN TAREAS ACTIVAS</div>';
    else visibles.forEach(t => cont.appendChild(crearCard(t)));
    setStatus(true, 'üü¢ Monitor Activo');
}

function escuchar() {
    db.channel('taller').on('postgres_changes', { event: '*', schema: 'public', table: 'tareas_taller' }, payload => {
        const t = payload.new;
        const id = t ? t.id_tarea : payload.old.id_tarea;
        
        if (payload.eventType === 'DELETE' || (t && !['PENDIENTE', 'EN_PROCESO', 'COTIZADO'].includes(t.estado))) {
            quitarCard(id);
        } else if (cumpleCondicionSalida(t)) {
            iniciarCountdown(id);
        } else {
            cargar(); // Recarga simple para mantener sincron√≠a total
        }
    }).subscribe();
}

cargar().then(escuchar);
</script>
</body>
</html>
