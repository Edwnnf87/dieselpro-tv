<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>Diesel Pro - Monitor de Taller</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0f172a; color: #ffffff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; background-color: #1e293b; padding: 20px 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .logo { background-color: #f59e0b; padding: 10px 20px; font-size: 28px; font-weight: bold; border-radius: 8px; color: #0f172a; }
        .title { font-size: 36px; font-weight: bold; color: #f8fafc; }
        .status-badge { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; }
        .status-badge.connected { background-color: rgba(16,185,129,0.2); color: #10b981; border: 1px solid #10b981; }
        .status-badge.disconnected { background-color: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid #ef4444; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; background-color: currentColor; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .clock { font-size: 42px; color: #38bdf8; font-family: monospace; font-weight: bold; }

        .grid-container { display: flex; flex-direction: column; gap: 15px; padding: 30px 40px; max-height: calc(100vh - 120px); overflow-y: auto; }
        
        .card { 
            display: grid; grid-template-columns: 0.8fr 1.3fr 1fr 0.9fr 1fr 0.65fr; 
            gap: 15px; align-items: center; background-color: #1e293b; 
            border-left: 12px solid #f59e0b; padding: 20px 25px; border-radius: 10px; 
            font-size: 20px; position: relative; transition: all 0.3s ease;
        }
        .card.en-proceso { border-left-color: #3b82f6; background-color: #172554; }
        .card.cotizado { border-left-color: #8b5cf6; background-color: #2e1065; }
        
        .card.saliendo { border-left-color: #10b981 !important; background-color: #052e16 !important; animation: parpadeo 1s infinite; }
        @keyframes parpadeo { 0%,100% { box-shadow: 0 0 20px rgba(16,185,129,0.4); } 50% { box-shadow: 0 0 45px rgba(16,185,129,0.9); } }
        
        .countdown-badge { position: absolute; top: 10px; right: 15px; background-color: #10b981; color: white; font-size: 13px; font-weight: bold; padding: 4px 14px; border-radius: 12px; }
        
        .removing { animation: fadeOut 0.7s forwards; overflow: hidden; pointer-events: none; }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(80px); max-height: 0; padding: 0; margin: 0; } }

        .fecha-label { font-size: 12px; color: #94a3b8; font-weight: bold; text-transform: uppercase; }
        .fecha-valor { font-size: 18px; color: #38bdf8; font-weight: bold; }
        .empresa { font-size: 24px; font-weight: bold; }
        .componente { font-size: 17px; color: #94a3b8; }
        .solicitante-valor { color: #fbbf24; font-weight: 600; }
        .operario { color: #fbbf24; font-weight: bold; }
        
        .badge-informe { padding: 8px 12px; border-radius: 15px; font-size: 14px; font-weight: bold; text-align: center; }
        .badge-informe.listo { background-color: #10b981; color: white; }
        .badge-informe.pendiente { background-color: #431407; color: #fed7aa; border: 1px solid #92400e; }
        
        .estado { font-size: 17px; font-weight: bold; padding: 10px 18px; border-radius: 20px; background-color: #fef3c7; color: #b45309; text-align: center; white-space: nowrap; }
        .empty-state { text-align: center; font-size: 40px; padding: 100px; color: #475569; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center; gap:20px;">
        <div class="logo">DP</div>
        <div class="title">MONITOR DE TALLER</div>
    </div>
    <div style="display:flex; align-items:center; gap:20px;">
        <div class="status-badge disconnected" id="status-badge">
            <div class="status-dot"></div>
            <span id="status-text">Iniciando...</span>
        </div>
        <div class="clock" id="reloj">00:00:00</div>
    </div>
</div>

<div class="grid-container" id="contenedor-tareas">
    <div class="empty-state">‚è≥ Cargando tareas del taller...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = 'https://uobfergikgoxqqnmdbgw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYmZlcmdpa2dveHFxbm1kYmd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTU5OTAsImV4cCI6MjA4NzQzMTk5MH0.FhJr4aDyMOyPv6ea44aYQSZhxeAK3988M-Zb4oVDgww';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const timersActivos = {};
const ESTADOS_PERMITIDOS = ['PENDIENTE', 'EN_PROCESO', 'COTIZADO'];

function actualizarReloj() {
    document.getElementById('reloj').textContent = new Date().toLocaleTimeString('es-PE', { hour12: false });
}
setInterval(actualizarReloj, 1000);

function setStatus(connected, text) {
    const badge = document.getElementById('status-badge');
    badge.className = `status-badge ${connected ? 'connected' : 'disconnected'}`;
    document.getElementById('status-text').textContent = text;
}

// Una tarea debe SALIR si tiene cotizaci√≥n Y el informe est√° listo (o no requiere)
function cumpleCondicionSalida(t) {
    const tieneCot = (t.nro_cotizacion_vinculada && t.nro_cotizacion_vinculada.trim() !== '');
    const informeOk = (!t.requiere_informe || t.informe_listo);
    return tieneCot && informeOk;
}

function formatFecha(raw) {
    if (!raw) return '--:--';
    const f = new Date(raw);
    return f.toLocaleDateString('es-PE', {day:'2-digit', month:'2-digit'}) + ' ' + f.toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'});
}

function crearCard(t) {
    const card = document.createElement('div');
    card.className = `card ${t.estado === 'COTIZADO' ? 'cotizado' : (t.estado === 'EN_PROCESO' ? 'en-proceso' : '')}`;
    card.dataset.id = t.id_tarea;
    
    // Mostramos el N√öMERO DE COTIZACI√ìN si el estado es COTIZADO
    const txtEstado = t.estado === 'COTIZADO' 
        ? `üìÑ ${t.nro_cotizacion_vinculada || 'COTIZADO'}` 
        : (t.estado === 'EN_PROCESO' ? '‚öôÔ∏è EN PROCESO' : 'üìã COT_PEND');

    card.innerHTML = `
        <div class="col-fecha"><span class="fecha-label">üìÖ Ingreso</span><br><span class="fecha-valor">${formatFecha(t.fecha_ingreso)}</span></div>
        <div class="col-empresa"><div class="empresa">${t.empresa || 'S/N'}</div><div class="componente">${t.componente || '---'}</div></div>
        <div><span class="fecha-label">üë§ Solicitante</span><br><span class="solicitante-valor">${t.solicitante || '---'}</span></div>
        <div class="operario">üîß ${t.operario_asignado || 'Sin asignar'}</div>
        <div style="text-align:center">${t.requiere_informe ? `<div class="badge-informe ${t.informe_listo?'listo':'pendiente'}">${t.informe_listo?'‚úÖ INFORME':'‚è≥ INFORME'}</div>` : ''}</div>
        <div class="estado">${txtEstado}</div>
    `;
    return card;
}

function quitarCard(idTarea) {
    const card = document.querySelector(`.card[data-id="${idTarea}"]`);
    if (card && !card.classList.contains('removing')) {
        if (timersActivos[idTarea]) { clearInterval(timersActivos[idTarea]); delete timersActivos[idTarea]; }
        card.classList.add('removing');
        setTimeout(() => { 
            card.remove(); 
            validarContenedorVacio();
        }, 700);
    }
}

function validarContenedorVacio() {
    const cont = document.getElementById('contenedor-tareas');
    if (cont.querySelectorAll('.card:not(.removing)').length === 0) {
        cont.innerHTML = '<div class="empty-state">‚úÖ SIN TAREAS ACTIVAS EN TALLER</div>';
    }
}

function iniciarCountdown(idTarea) {
    if (timersActivos[idTarea]) return;
    const card = document.querySelector(`.card[data-id="${idTarea}"]`);
    if (!card) return;

    card.classList.add('saliendo');
    let s = 10;
    const b = document.createElement('div');
    b.className = 'countdown-badge';
    b.textContent = `‚úÖ Completado ¬∑ saliendo en ${s}s`;
    card.appendChild(b);

    timersActivos[idTarea] = setInterval(() => {
        s--;
        b.textContent = `‚úÖ Completado ¬∑ saliendo en ${s}s`;
        if (s <= 0) { quitarCard(idTarea); }
    }, 1000);
}

async function cargarDatos() {
    // Solo traemos los estados que pertenecen al taller
    const { data, error } = await db.from('tareas_taller')
        .select('*')
        .in('estado', ESTADOS_PERMITIDOS)
        .order('fecha_ingreso', {ascending: true});

    if (error) { setStatus(false, 'Error de conexi√≥n'); return; }

    const cont = document.getElementById('contenedor-tareas');
    const tareasParaMostrar = data.filter(t => !cumpleCondicionSalida(t));

    // Si una tarea ya estaba en pantalla pero NO vino en la nueva lista, la quitamos (Limpia cancelados)
    const cardsEnPantalla = document.querySelectorAll('.card');
    cardsEnPantalla.forEach(card => {
        const id = parseInt(card.dataset.id);
        if (!tareasParaMostrar.find(t => t.id_tarea === id)) {
            quitarCard(id);
        }
    });

    // A√±adir o actualizar las que s√≠ deben estar
    if (tareasParaMostrar.length === 0) {
        validarContenedorVacio();
    } else {
        const empty = cont.querySelector('.empty-state');
        if (empty) empty.remove();

        tareasParaMostrar.forEach(t => {
            const existe = document.querySelector(`.card[data-id="${t.id_tarea}"]`);
            if (!existe) {
                cont.appendChild(crearCard(t));
            } else if (!existe.classList.contains('removing') && !existe.classList.contains('saliendo')) {
                // Actualizaci√≥n r√°pida de contenido
                const clon = crearCard(t);
                existe.innerHTML = clon.innerHTML;
                existe.className = clon.className;
            }
        });
    }
    setStatus(true, 'üü¢ Monitor Activo');
}

function iniciarEscuchaRealtime() {
    db.channel('cambios-taller')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'tareas_taller' }, payload => {
            console.log('Cambio detectado:', payload.eventType, payload.new);
            
            // Si es un borrado o el nuevo estado NO es de taller, quitar de pantalla
            if (payload.eventType === 'DELETE' || (payload.new && !ESTADOS_PERMITIDOS.includes(payload.new.estado))) {
                quitarCard(payload.new ? payload.new.id_tarea : payload.old.id_tarea);
                return;
            }

            // Si cumple condici√≥n de salida (Cotizado + Informe), iniciar countdown
            if (cumpleCondicionSalida(payload.new)) {
                iniciarCountdown(payload.new.id_tarea);
            } else {
                // Para cualquier otro cambio (incluyendo el n√∫mero de cotizaci√≥n), refrescar
                cargarDatos();
            }
        })
        .subscribe();
}

// Inicio
cargarDatos().then(iniciarEscuchaRealtime);

// Refresco de seguridad cada 2 minutos (por si falla el realtime)
setInterval(cargarDatos, 120000);

</script>
</body>
</html>
